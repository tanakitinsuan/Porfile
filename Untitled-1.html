<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
        }
        .music-player {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 50%, #94a3b8 100%);
        }
        .spotify-button {
            background: #64748b;
            transition: all 0.3s ease;
        }
        .spotify-button:hover {
            background: #475569;
            transform: scale(1.05);
        }
        .playlist-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .playlist-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="text-center py-12">
        <h1 class="text-5xl font-bold text-slate-700 mb-4">@fsecondthird</h1>
        <p class="text-xl text-slate-600">‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏°‡∏µ‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï</p>
    </header>

    <!-- Music Player Section -->
    <div class="max-w-6xl mx-auto mb-12 px-6">
        <div class="music-player rounded-2xl p-8 text-slate-700 text-center shadow-2xl backdrop-blur-sm">
            <h2 class="text-2xl font-semibold mb-6">üéµ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á Spotify</h2>
            
            <!-- Admin Only - Hidden by default -->
            <div id="adminControls" class="mb-6 hidden">
                <input type="text" id="spotifyUri" placeholder="‡πÉ‡∏™‡πà Spotify URI ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå" 
                       class="w-full max-w-md px-4 py-3 rounded-lg text-gray-800 bg-white bg-opacity-90 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-300">
                <button id="loadTrack" class="ml-2 spotify-button px-6 py-3 rounded-lg font-semibold text-white">
                    ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á
                </button>
            </div>

            <!-- Public Playlist Selection -->
            <div id="publicPlaylistSelection" class="mb-6">
                <h3 class="text-lg font-medium mb-4">üéµ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</h3>
                <div id="publicPlaylists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Public playlists will be loaded here -->
                </div>
            </div>

            <!-- Spotify Player -->
            <div class="mb-6">
                <div id="spotify-player" class="mx-auto rounded-lg overflow-hidden shadow-lg bg-black" style="width: 100%; max-width: 400px; height: 152px;">
                    <iframe id="spotify-iframe" 
                            src="https://open.spotify.com/embed/track/4iV5W9uYEdYUVa79Axb7Rh?utm_source=generator&theme=0" 
                            width="100%" 
                            height="152" 
                            frameBorder="0" 
                            allowfullscreen="" 
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>

            <!-- Player Controls - Always visible -->
            <div class="mb-6">
                <div class="flex items-center justify-center space-x-6 mb-4">
                    <button id="prevBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-4 transition-all duration-300" title="‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
                        <i class="fas fa-backward text-2xl"></i>
                    </button>
                    <button id="nextBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-4 transition-all duration-300" title="‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                        <i class="fas fa-forward text-2xl"></i>
                    </button>
                </div>
                <div id="playlistStatus" class="text-sm text-slate-500 text-center">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á
                </div>
            </div>

            <!-- Current Song Info -->
            <div id="songInfo" class="text-slate-600 mb-6 hidden">
                <p class="text-lg font-medium">üéµ Shape of You</p>
                <p class="text-sm text-slate-500">Ed Sheeran</p>
            </div>

            <!-- Statistics -->
            <div class="mt-6 bg-white bg-opacity-30 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3 text-slate-700">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-slate-600" id="visitorCount">0</div>
                        <div class="text-sm text-slate-500">‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-slate-600" id="playlistCount">0</div>
                        <div class="text-sm text-slate-500">‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</div>
                    </div>
                </div>
            </div>

            <!-- Admin Playlist Management -->
            <div id="adminPlaylist" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-4">üéµ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå (Admin)</h3>
                
                <!-- Create New Playlist -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-medium mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h4>
                    <div class="flex gap-3 mb-3">
                        <input type="text" id="newPlaylistName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå" 
                               class="flex-1 px-3 py-2 rounded text-gray-800 text-sm">
                        <button id="createPlaylistBtn" class="spotify-button px-4 py-2 rounded text-sm font-medium text-white">
                            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á
                        </button>
                    </div>
                </div>

                <!-- Add New Song -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-medium mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <input type="text" id="newSongSpotifyId" placeholder="‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏•‡∏á Spotify" 
                               class="px-3 py-2 rounded text-gray-800 text-sm">
                        <select id="targetPlaylist" class="px-3 py-2 rounded text-gray-800 text-sm">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</option>
                        </select>
                    </div>
                    <button id="addSongBtn" class="spotify-button px-4 py-2 rounded text-sm font-medium text-white">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á
                    </button>
                </div>

                <!-- Playlists List -->
                <div id="playlistsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Playlists will be loaded here -->
                </div>
            </div>

            <!-- Admin Toggle Button -->
            <div class="mt-6">
                <button id="adminToggle" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                    üîê Admin Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Instagram Link Section -->
    <div class="max-w-4xl mx-auto px-6 mb-12">
        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-2xl p-8 text-center shadow-2xl">
            <h2 class="text-3xl font-bold text-slate-700 mb-6">‡πÑ‡∏≠‡∏à‡∏µ</h2>
            <p class="text-slate-600 mb-8 text-lg">‡πÅ‡∏≠‡∏ö‡∏™‡πà‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏à‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
            
            <a href="https://www.instagram.com/fsecondthird" target="_blank" class="spotify-button inline-flex items-center px-8 py-4 rounded-full text-white font-semibold text-lg hover:no-underline">
                <i class="fab fa-instagram text-2xl mr-3"></i>
                ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Instagram
            </a>
            
            <div class="mt-8 flex justify-center space-x-8 text-slate-500">
                <div class="text-center">
                    <div class="text-2xl font-bold text-slate-600" id="instagramPosts">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div class="text-sm">‡πÇ‡∏û‡∏™‡∏ï‡πå</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-slate-600" id="instagramFollowers">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div class="text-sm">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-slate-600" id="instagramFollowing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-8 text-slate-600">
        <p>&copy; 2024 Spotify Music Player. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‚ù§Ô∏è</p>
    </footer>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, increment, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC3vNG3q2ullVGvVUKAcWXuAaYaWUrOX7A",
            authDomain: "loyalty-point-e3acc.firebaseapp.com",
            databaseURL: "https://loyalty-point-e3acc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "loyalty-point-e3acc",
            storageBucket: "loyalty-point-e3acc.firebasestorage.app",
            messagingSenderId: "133851373092",
            appId: "1:133851373092:web:d04bb08d6e8fc88ce742b1",
            measurementId: "G-C8VFNHXXR4"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbOnValue = onValue;
        window.dbIncrement = increment;
        window.dbPush = push;
    </script>
    
    <script>
        let isAdmin = false;
        let playlistsData = {};
        let songsData = {};
        let currentPlaylist = null;
        let currentSongIndex = 0;
        let currentTrackId = '4iV5W9uYEdYUVa79Axb7Rh'; // Default track

        // Firebase Functions
        async function initializeFirebase() {
            try {
                await countVisitor();
                await loadPlaylistsFromDB();
                await loadSongsFromDB();
                await loadCurrentTrack();
                setupRealtimeListeners();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        async function loadCurrentTrack() {
            try {
                const trackRef = window.dbRef(window.database, 'currentTrack');
                const snapshot = await window.dbGet(trackRef);
                
                if (snapshot.exists()) {
                    const trackData = snapshot.val();
                    currentTrackId = trackData.trackId;
                    loadSpotifyTrack(currentTrackId);
                    if (trackData.title && trackData.artist) {
                        updateSongInfo(trackData.title, trackData.artist);
                    }
                }
            } catch (error) {
                console.error('Error loading current track:', error);
            }
        }

        async function saveCurrentTrack(trackId, title = '', artist = '') {
            try {
                const trackRef = window.dbRef(window.database, 'currentTrack');
                await window.dbSet(trackRef, {
                    trackId: trackId,
                    title: title,
                    artist: artist,
                    updatedAt: Date.now()
                });
                currentTrackId = trackId;
            } catch (error) {
                console.error('Error saving current track:', error);
            }
        }

        async function countVisitor() {
            try {
                const visitorRef = window.dbRef(window.database, 'stats/visitors');
                await window.dbSet(visitorRef, window.dbIncrement(1));
            } catch (error) {
                console.error('Error counting visitor:', error);
            }
        }

        async function loadPlaylistsFromDB() {
            try {
                const playlistsRef = window.dbRef(window.database, 'playlists');
                const snapshot = await window.dbGet(playlistsRef);
                
                if (snapshot.exists()) {
                    playlistsData = snapshot.val();
                } else {
                    // Initialize with default playlists
                    const defaultPlaylists = {
                        'hits': {
                            name: 'Top Hits',
                            description: '‡πÄ‡∏û‡∏•‡∏á‡∏Æ‡∏¥‡∏ï‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°',
                            songs: ['4iV5W9uYEdYUVa79Axb7Rh', '7qiZfU4dY1lWllzX7mPBI3', '0VjIjW4GlULA4LGwqf0YVk']
                        },
                        'chill': {
                            name: 'Chill Vibes',
                            description: '‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ö‡∏≤‡∏¢‡πÜ ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢',
                            songs: ['4uLU6hMCjMI75M1A2tKUQC', '2plbrEY59IikOBgBGLjaoe', '1Je1IMUlBXcx1Fz0WE7oPT']
                        }
                    };
                    
                    await window.dbSet(window.dbRef(window.database, 'playlists'), defaultPlaylists);
                    playlistsData = defaultPlaylists;
                }
                updatePlaylistsList();
                updatePlaylistCount();
                
                // Auto-play first available playlist for visitors
                autoPlayFirstPlaylist();
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        }

        function autoPlayFirstPlaylist() {
            // Find first playlist with songs
            const availablePlaylists = Object.entries(playlistsData).filter(([id, playlist]) => 
                playlist.songs && playlist.songs.length > 0
            );
            
            if (availablePlaylists.length > 0) {
                const [firstPlaylistId, firstPlaylist] = availablePlaylists[0];
                // Auto-play the first playlist
                setTimeout(() => {
                    playPlaylist(firstPlaylistId);
                }, 1000); // Small delay to ensure everything is loaded
            }
        }

        async function loadSongsFromDB() {
            try {
                const songsRef = window.dbRef(window.database, 'songs');
                const snapshot = await window.dbGet(songsRef);
                
                if (snapshot.exists()) {
                    songsData = snapshot.val();
                } else {
                    // Initialize with default songs
                    const defaultSongs = {
                        '4iV5W9uYEdYUVa79Axb7Rh': {
                            title: 'Shape of You',
                            artist: 'Ed Sheeran',
                            spotifyId: '4iV5W9uYEdYUVa79Axb7Rh'
                        },
                        '7qiZfU4dY1lWllzX7mPBI3': {
                            title: 'Blinding Lights',
                            artist: 'The Weeknd',
                            spotifyId: '7qiZfU4dY1lWllzX7mPBI3'
                        },
                        '0VjIjW4GlULA4LGwqf0YVk': {
                            title: 'Watermelon Sugar',
                            artist: 'Harry Styles',
                            spotifyId: '0VjIjW4GlULA4LGwqf0YVk'
                        },
                        '4uLU6hMCjMI75M1A2tKUQC': {
                            title: 'Heat Waves',
                            artist: 'Glass Animals',
                            spotifyId: '4uLU6hMCjMI75M1A2tKUQC'
                        },
                        '2plbrEY59IikOBgBGLjaoe': {
                            title: 'Levitating',
                            artist: 'Dua Lipa',
                            spotifyId: '2plbrEY59IikOBgBGLjaoe'
                        },
                        '1Je1IMUlBXcx1Fz0WE7oPT': {
                            title: 'As It Was',
                            artist: 'Harry Styles',
                            spotifyId: '1Je1IMUlBXcx1Fz0WE7oPT'
                        }
                    };
                    
                    await window.dbSet(window.dbRef(window.database, 'songs'), defaultSongs);
                    songsData = defaultSongs;
                }
                updateSongCount();
            } catch (error) {
                console.error('Error loading songs:', error);
            }
        }

        function setupRealtimeListeners() {
            // Listen for visitor count changes
            const visitorRef = window.dbRef(window.database, 'stats/visitors');
            window.dbOnValue(visitorRef, (snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('visitorCount').textContent = count.toLocaleString();
            });

            // Listen for playlists changes
            const playlistsRef = window.dbRef(window.database, 'playlists');
            window.dbOnValue(playlistsRef, (snapshot) => {
                if (snapshot.exists()) {
                    playlistsData = snapshot.val();
                    updatePlaylistsList();
                    updatePlaylistCount();
                    updateTargetPlaylistSelect();
                }
            });

            // Listen for songs changes
            const songsRef = window.dbRef(window.database, 'songs');
            window.dbOnValue(songsRef, (snapshot) => {
                if (snapshot.exists()) {
                    songsData = snapshot.val();
                    updateSongCount();
                }
            });

            // Listen for current track changes
            const currentTrackRef = window.dbRef(window.database, 'currentTrack');
            window.dbOnValue(currentTrackRef, (snapshot) => {
                if (snapshot.exists()) {
                    const trackData = snapshot.val();
                    if (trackData.trackId !== currentTrackId) {
                        currentTrackId = trackData.trackId;
                        loadSpotifyTrack(currentTrackId);
                        if (trackData.title && trackData.artist) {
                            updateSongInfo(trackData.title, trackData.artist);
                        }
                    }
                }
            });
        }

        function updatePlaylistCount() {
            const count = Object.keys(playlistsData).length;
            document.getElementById('playlistCount').textContent = count;
        }

        function updateSongCount() {
            const count = Object.keys(songsData).length;
            document.getElementById('songCount').textContent = count;
        }

        function updateTargetPlaylistSelect() {
            const select = document.getElementById('targetPlaylist');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</option>';
            
            Object.entries(playlistsData).forEach(([id, playlist]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = playlist.name;
                select.appendChild(option);
            });
        }

        function updatePlaylistsList() {
            const playlistsList = document.getElementById('playlistsList');
            playlistsList.innerHTML = '';

            Object.entries(playlistsData).forEach(([id, playlist]) => {
                const playlistElement = document.createElement('div');
                playlistElement.className = 'playlist-card bg-white bg-opacity-10 hover:bg-opacity-20 p-6 rounded-lg transition-all duration-300';
                
                const songCount = playlist.songs ? playlist.songs.length : 0;
                
                playlistElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-slate-700 mb-2">${playlist.name}</h4>
                            <p class="text-sm text-slate-500 mb-2">${playlist.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</p>
                            <p class="text-xs text-gray-400">${songCount} ‡πÄ‡∏û‡∏•‡∏á</p>
                        </div>
                        <button class="delete-playlist text-red-400 hover:text-red-300 ml-2" data-playlist-id="${id}">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${playlist.songs ? playlist.songs.slice(0, 3).map(songId => {
                            const song = songsData[songId];
                            return song ? `
                                <div class="text-xs text-gray-300 flex justify-between items-center">
                                    <span>${song.title} - ${song.artist}</span>
                                    <button class="remove-song text-red-400 hover:text-red-300" data-playlist-id="${id}" data-song-id="${songId}">
                                        <i class="fas fa-times text-xs"></i>
                                    </button>
                                </div>
                            ` : '';
                        }).join('') : '<div class="text-xs text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á</div>'}
                        ${songCount > 3 ? `<div class="text-xs text-gray-400">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${songCount - 3} ‡πÄ‡∏û‡∏•‡∏á...</div>` : ''}
                    </div>
                    
                    <button class="play-playlist w-full spotify-button px-4 py-2 rounded text-sm font-medium text-white" data-playlist-id="${id}">
                        ‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå
                    </button>
                `;
                playlistsList.appendChild(playlistElement);
            });

            // Add event listeners
            document.querySelectorAll('.play-playlist').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playlistId = this.getAttribute('data-playlist-id');
                    playPlaylist(playlistId);
                });
            });

            document.querySelectorAll('.delete-playlist').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (isAdmin) {
                        const playlistId = this.getAttribute('data-playlist-id');
                        deletePlaylist(playlistId);
                    }
                });
            });

            document.querySelectorAll('.remove-song').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (isAdmin) {
                        const playlistId = this.getAttribute('data-playlist-id');
                        const songId = this.getAttribute('data-song-id');
                        removeSongFromPlaylist(playlistId, songId);
                    }
                });
            });

            // Update public playlists for visitors
            updatePublicPlaylists();
        }

        function updatePublicPlaylists() {
            const publicPlaylistsContainer = document.getElementById('publicPlaylists');
            publicPlaylistsContainer.innerHTML = '';

            Object.entries(playlistsData).forEach(([id, playlist]) => {
                const songCount = playlist.songs ? playlist.songs.length : 0;
                
                if (songCount > 0) { // Only show playlists with songs
                    const playlistCard = document.createElement('div');
                    playlistCard.className = 'bg-white bg-opacity-10 hover:bg-opacity-20 p-4 rounded-lg cursor-pointer transition-all duration-300 transform hover:scale-105';
                    
                    playlistCard.innerHTML = `
                        <div class="text-center">
                            <div class="text-3xl mb-2">üéµ</div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-1">${playlist.name}</h4>
                            <p class="text-sm text-slate-500 mb-2">${playlist.description || '‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©'}</p>
                            <p class="text-xs text-gray-300">${songCount} ‡πÄ‡∏û‡∏•‡∏á</p>
                        </div>
                    `;
                    
                    playlistCard.addEventListener('click', function() {
                        playPlaylist(id);
                        // Scroll to player
                        document.getElementById('spotify-player').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    });
                    
                    publicPlaylistsContainer.appendChild(playlistCard);
                }
            });

            // If no playlists available, show message
            if (publicPlaylistsContainer.children.length === 0) {
                publicPlaylistsContainer.innerHTML = `
                    <div class="col-span-full text-center text-slate-500 py-8">
                        <div class="text-4xl mb-4">üéµ</div>
                        <p class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</p>
                        <p class="text-sm text-slate-400">‡∏£‡∏≠ Admin ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                    </div>
                `;
            }
        }

        async function createPlaylist(name) {
            if (!window.database || !window.dbRef || !window.dbSet) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            try {
                const playlistId = Date.now().toString();
                const playlistRef = window.dbRef(window.database, `playlists/${playlistId}`);
                await window.dbSet(playlistRef, {
                    name: name,
                    description: '',
                    songs: [],
                    createdAt: Date.now()
                });
                
                document.getElementById('newPlaylistName').value = '';
                alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function deletePlaylist(playlistId) {
            if (!window.database || !window.dbRef || !window.dbSet) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    const playlistRef = window.dbRef(window.database, `playlists/${playlistId}`);
                    await window.dbSet(playlistRef, null);
                    alert('‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } catch (error) {
                    console.error('Error deleting playlist:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        }

        async function addSong(spotifyId, playlistId) {
            if (!window.database || !window.dbRef || !window.dbSet) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            try {
                // Get song info from Spotify (using a simple method)
                const title = `‡πÄ‡∏û‡∏•‡∏á ${spotifyId.substring(0, 8)}...`;
                const artist = '‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                
                // Add song to songs collection
                const songRef = window.dbRef(window.database, `songs/${spotifyId}`);
                await window.dbSet(songRef, {
                    title: title,
                    artist: artist,
                    spotifyId: spotifyId,
                    addedAt: Date.now()
                });

                // Add song to playlist if specified
                if (playlistId && playlistsData[playlistId]) {
                    const playlist = playlistsData[playlistId];
                    const updatedSongs = playlist.songs ? [...playlist.songs, spotifyId] : [spotifyId];
                    
                    const playlistRef = window.dbRef(window.database, `playlists/${playlistId}/songs`);
                    await window.dbSet(playlistRef, updatedSongs);
                }
                
                // Clear form
                document.getElementById('newSongSpotifyId').value = '';
                document.getElementById('targetPlaylist').value = '';
                
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Error adding song:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function removeSongFromPlaylist(playlistId, songId) {
            if (!window.database || !window.dbRef || !window.dbSet) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    const playlist = playlistsData[playlistId];
                    const updatedSongs = playlist.songs.filter(id => id !== songId);
                    
                    const playlistRef = window.dbRef(window.database, `playlists/${playlistId}/songs`);
                    await window.dbSet(playlistRef, updatedSongs);
                    
                    alert('‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } catch (error) {
                    console.error('Error removing song from playlist:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        }

        function playPlaylist(playlistId) {
            const playlist = playlistsData[playlistId];
            if (playlist && playlist.songs && playlist.songs.length > 0) {
                currentPlaylist = playlist.songs;
                currentSongIndex = 0;
                playCurrentSong();
                updatePlaylistStatus(playlist.name, playlist.songs.length);
            }
        }

        function updatePlaylistStatus(playlistName, songCount) {
            const statusElement = document.getElementById('playlistStatus');
            statusElement.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ${playlistName} (${currentSongIndex + 1}/${songCount})`;
        }

        function playCurrentSong() {
            if (currentPlaylist && currentPlaylist[currentSongIndex]) {
                const songId = currentPlaylist[currentSongIndex];
                const song = songsData[songId];
                
                if (song) {
                    loadSpotifyTrack(song.spotifyId);
                    updateSongInfo(song.title, song.artist);
                    saveCurrentTrack(song.spotifyId, song.title, song.artist);
                }
            }
        }

        function loadSpotifyTrack(trackId) {
            const iframe = document.getElementById('spotify-iframe');
            // Remove timestamp parameter that was causing songs to start at the end
            iframe.src = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`;
        }

        function updateSongInfo(title, artist) {
            // Song info display is disabled
        }

        function extractSpotifyId(url) {
            const regExp = /(?:spotify:track:|https:\/\/open\.spotify\.com\/track\/)([a-zA-Z0-9]+)/;
            const match = url.match(regExp);
            return match ? match[1] : url;
        }

        // Instagram Data Functions
        async function loadInstagramData() {
            try {
                // Show loading state
                updateInstagramDisplay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
                
                // Try to load from Firebase first
                const igRef = window.dbRef(window.database, 'instagram');
                const snapshot = await window.dbGet(igRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const now = Date.now();
                    const thirtyMinutes = 30 * 60 * 1000; // 30 minutes in milliseconds
                    
                    // If data is less than 30 minutes old, use cached data
                    if (data.lastUpdated && (now - data.lastUpdated) < thirtyMinutes) {
                        updateInstagramDisplay(data.posts, data.followers, data.following);
                        return;
                    }
                }
                
                // Fetch new data
                await fetchInstagramData();
            } catch (error) {
                console.error('Error loading Instagram data:', error);
                // Show fallback data
                updateInstagramDisplay('2.8K', '18.2K', '1.1K');
            }
        }

        async function fetchInstagramData() {
            try {
                // Multiple methods to try fetching Instagram data
                let instagramData = null;
                
                // Method 1: Try Instagram Basic Display API proxy
                try {
                    const proxyUrl = 'https://api.allorigins.win/get?url=';
                    const instagramUrl = encodeURIComponent('https://www.instagram.com/fsecondthird/?__a=1&__d=dis');
                    const response = await fetch(proxyUrl + instagramUrl);
                    const data = await response.json();
                    
                    if (data.contents) {
                        const jsonData = JSON.parse(data.contents);
                        if (jsonData.graphql && jsonData.graphql.user) {
                            const user = jsonData.graphql.user;
                            instagramData = {
                                posts: formatNumber(user.edge_owner_to_timeline_media.count),
                                followers: formatNumber(user.edge_followed_by.count),
                                following: formatNumber(user.edge_follow.count)
                            };
                        }
                    }
                } catch (e) {
                    console.log('Method 1 failed:', e);
                }
                
                // Method 2: Try scraping with different proxy
                if (!instagramData) {
                    try {
                        const corsProxy = 'https://cors-anywhere.herokuapp.com/';
                        const response = await fetch(corsProxy + 'https://www.instagram.com/fsecondthird/', {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        const html = await response.text();
                        
                        // Extract data from HTML using regex
                        const followersMatch = html.match(/"edge_followed_by":{"count":(\d+)}/);
                        const followingMatch = html.match(/"edge_follow":{"count":(\d+)}/);
                        const postsMatch = html.match(/"edge_owner_to_timeline_media":{"count":(\d+)}/);
                        
                        if (followersMatch && followingMatch && postsMatch) {
                            instagramData = {
                                posts: formatNumber(parseInt(postsMatch[1])),
                                followers: formatNumber(parseInt(followersMatch[1])),
                                following: formatNumber(parseInt(followingMatch[1]))
                            };
                        }
                    } catch (e) {
                        console.log('Method 2 failed:', e);
                    }
                }
                
                // Method 3: Try Instagram public API
                if (!instagramData) {
                    try {
                        const response = await fetch('https://instagram.com/api/v1/users/web_profile_info/?username=fsecondthird', {
                            headers: {
                                'X-IG-App-ID': '936619743392459'
                            }
                        });
                        const data = await response.json();
                        
                        if (data.data && data.data.user) {
                            const user = data.data.user;
                            instagramData = {
                                posts: formatNumber(user.edge_owner_to_timeline_media.count),
                                followers: formatNumber(user.edge_followed_by.count),
                                following: formatNumber(user.edge_follow.count)
                            };
                        }
                    } catch (e) {
                        console.log('Method 3 failed:', e);
                    }
                }
                
                // If all methods fail, use static fallback data
                if (!instagramData) {
                    instagramData = {
                        posts: '2.8K',
                        followers: '18.2K',
                        following: '1.1K'
                    };
                }
                
                // Save to Firebase
                const igRef = window.dbRef(window.database, 'instagram');
                await window.dbSet(igRef, {
                    posts: instagramData.posts,
                    followers: instagramData.followers,
                    following: instagramData.following,
                    lastUpdated: Date.now(),
                    fetchMethod: instagramData.method || 'simulated'
                });
                
                updateInstagramDisplay(instagramData.posts, instagramData.followers, instagramData.following);
                
            } catch (error) {
                console.error('Error fetching Instagram data:', error);
                // Show fallback data
                updateInstagramDisplay('2.8K', '18.2K', '1.1K');
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function updateInstagramDisplay(posts, followers, following) {
            document.getElementById('instagramPosts').textContent = posts;
            document.getElementById('instagramFollowers').textContent = followers;
            document.getElementById('instagramFollowing').textContent = following;
        }

        // Initialize Firebase when page loads
        window.addEventListener('load', function() {
            const checkFirebase = () => {
                if (window.database && window.dbRef && window.dbSet) {
                    initializeFirebase();
                    loadInstagramData(); // Load Instagram data after Firebase is ready
                } else {
                    setTimeout(checkFirebase, 500);
                }
            };
            checkFirebase();
        });

        // Admin Toggle
        document.getElementById('adminToggle').addEventListener('click', function() {
            const password = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:');
            if (password === 'admin123') {
                isAdmin = true;
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('adminPlaylist').classList.remove('hidden');
                this.textContent = 'üîì Admin Mode (Active)';
                this.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                this.classList.add('bg-green-600', 'hover:bg-green-700');
                updateTargetPlaylistSelect();
                alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Admin Mode ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } else if (password !== null) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        });

        // Load Track Button
        document.getElementById('loadTrack').addEventListener('click', function() {
            if (isAdmin) {
                const uri = document.getElementById('spotifyUri').value;
                if (uri) {
                    const trackId = extractSpotifyId(uri);
                    loadSpotifyTrack(trackId);
                    saveCurrentTrack(trackId);
                    document.getElementById('spotifyUri').value = '';
                }
            }
        });

        // Create Playlist Button
        document.getElementById('createPlaylistBtn').addEventListener('click', function() {
            if (isAdmin) {
                const name = document.getElementById('newPlaylistName').value.trim();
                if (name) {
                    createPlaylist(name);
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå');
                }
            }
        });

        // Add Song Button
        document.getElementById('addSongBtn').addEventListener('click', function() {
            if (isAdmin) {
                let spotifyId = document.getElementById('newSongSpotifyId').value.trim();
                const playlistId = document.getElementById('targetPlaylist').value;
                
                if (spotifyId) {
                    spotifyId = extractSpotifyId(spotifyId);
                    addSong(spotifyId, playlistId);
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏•‡∏á Spotify');
                }
            }
        });

        // Player Controls
        document.getElementById('prevBtn').addEventListener('click', function() {
            if (currentPlaylist && currentPlaylist.length > 0) {
                currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
                playCurrentSong();
                // Update status
                const playlistName = getCurrentPlaylistName();
                if (playlistName) {
                    updatePlaylistStatus(playlistName, currentPlaylist.length);
                }
            }
        });

        document.getElementById('nextBtn').addEventListener('click', function() {
            if (currentPlaylist && currentPlaylist.length > 0) {
                currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
                playCurrentSong();
                // Update status
                const playlistName = getCurrentPlaylistName();
                if (playlistName) {
                    updatePlaylistStatus(playlistName, currentPlaylist.length);
                }
            }
        });

        function getCurrentPlaylistName() {
            // Find current playlist name
            for (const [id, playlist] of Object.entries(playlistsData)) {
                if (playlist.songs && JSON.stringify(playlist.songs) === JSON.stringify(currentPlaylist)) {
                    return playlist.name;
                }
            }
            return '‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå';
        }

        // Enter key support
        document.getElementById('spotifyUri').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && isAdmin) {
                document.getElementById('loadTrack').click();
            }
        });

        document.getElementById('newPlaylistName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && isAdmin) {
                document.getElementById('createPlaylistBtn').click();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976e045f802f7b68',t:'MTc1NjQ5MTE1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
